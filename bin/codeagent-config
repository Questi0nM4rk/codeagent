#!/bin/bash
# ============================================
# CodeAgent Config
# Configure API keys without reinstalling
# ============================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"
ENV_FILE="$INSTALL_DIR/.env"

# ============================================
# Helper Functions
# ============================================

log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_info() { echo -e "${BLUE}○${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }

# Helper to safely set a key (removes duplicates first)
set_env_key() {
    local key="$1"
    local value="$2"
    sed -i "/^$key=/d" "$ENV_FILE" 2>/dev/null || true
    echo "$key=$value" >> "$ENV_FILE"
}

# ============================================
# Configure a single API key
# ============================================
configure_key() {
    local key_name="$1"
    local description="$2"
    local required="$3"
    local example="$4"

    echo ""

    # Check for existing value in env file
    local existing_value=""
    if grep -q "^$key_name=" "$ENV_FILE" 2>/dev/null; then
        existing_value=$(grep "^$key_name=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
    fi

    # If key exists and is not placeholder, show current status
    if [ -n "$existing_value" ] && [ "$existing_value" != "REPLACE_WITH_YOUR_KEY" ]; then
        echo -e "  ${GREEN}✓${NC} $key_name: configured"
        echo -n "    Replace? [y/N]: "
        read -r replace
        if [ "$replace" != "y" ] && [ "$replace" != "Y" ]; then
            return
        fi
    fi

    # Check for key in environment
    if [ -n "${!key_name}" ]; then
        log_info "Found $key_name in environment"
        echo -n "  Use it? [Y/n]: "
        read -r use_env
        if [ "$use_env" != "n" ] && [ "$use_env" != "N" ]; then
            set_env_key "$key_name" "${!key_name}"
            log_success "$key_name: copied from environment"
            return
        fi
    fi

    # Prompt for key
    if [ "$required" = "required" ]; then
        log_warn "$key_name - $description"
        echo -n "  Enter $key_name (e.g., $example): "
    else
        log_info "$key_name (optional) - $description"
        echo -n "  Enter $key_name or press Enter to skip: "
    fi

    read -r new_value
    if [ -n "$new_value" ]; then
        set_env_key "$key_name" "$new_value"
        log_success "$key_name: saved"
    elif [ "$required" = "required" ]; then
        set_env_key "$key_name" "REPLACE_WITH_YOUR_KEY"
        log_warn "$key_name: placeholder added - run 'codeagent config' again to set it"
    else
        log_info "$key_name: skipped"
    fi
}

# ============================================
# Main
# ============================================

echo -e "${CYAN}CodeAgent API Configuration${NC}"
echo "============================"
echo ""
echo -e "Keys are stored in: ${BLUE}$ENV_FILE${NC}"

# Ensure .env file exists
if [ ! -f "$ENV_FILE" ]; then
    mkdir -p "$INSTALL_DIR"
    cat > "$ENV_FILE" << 'ENVHEADER'
# CodeAgent API Keys
# ===================
ENVHEADER
    log_info "Created $ENV_FILE"
fi

echo ""
echo -e "${BLUE}Required:${NC}"
configure_key "OPENAI_API_KEY" "needed for Letta memory (~\$4/month)" "required" "sk-..."

echo ""
echo -e "${BLUE}Optional:${NC}"
configure_key "GITHUB_TOKEN" "enables GitHub MCP integration" "optional" "ghp_..."
configure_key "TAVILY_API_KEY" "enables web research MCP" "optional" "tvly-..."

echo ""
echo -e "${GREEN}Configuration complete!${NC}"
echo ""

# Show summary
echo "Current configuration:"
for key in OPENAI_API_KEY GITHUB_TOKEN TAVILY_API_KEY; do
    value=$(grep "^$key=" "$ENV_FILE" 2>/dev/null | tail -1 | cut -d= -f2-)
    if [ -n "$value" ] && [ "$value" != "REPLACE_WITH_YOUR_KEY" ]; then
        echo -e "  ${GREEN}✓${NC} $key: configured"
    else
        echo -e "  ${YELLOW}○${NC} $key: not set"
    fi
done

echo ""
echo -e "${CYAN}Note:${NC} Restart Docker services to apply changes:"
echo -e "  ${YELLOW}cd ~/.codeagent/infrastructure && docker compose restart${NC}"
