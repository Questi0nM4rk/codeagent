#!/bin/bash
# ============================================
# CodeAgent CLI
# Main entry point for all codeagent commands
# ============================================

set -e

INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"
VERSION="0.1.0"

# Colors
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
  echo -e "${CYAN}CodeAgent v$VERSION${NC} - Research-Backed Autonomous Coding Framework"
  echo ""
  echo "Usage: codeagent <command> [options]"
  echo ""
  echo -e "${BLUE}Infrastructure Commands:${NC}"
  echo "  start         Start all services (Qdrant)"
  echo "  stop          Stop all services"
  echo "  restart       Restart all services"
  echo "  status        Check service health (-w for watch, -r for auto-restart)"
  echo "  logs          View service logs (use -f for follow, service name for filter)"
  echo ""
  echo -e "${BLUE}Project Commands:${NC}"
  echo "  init          Initialize CodeAgent in current project"
  echo "  index         Rebuild codebase index (incremental by default, --full for complete)"
  echo "  backlog       View project backlog summary"
  echo "  worktree      Manage git worktrees for parallel execution (internal)"
  echo ""
  echo -e "${BLUE}Configuration Commands:${NC}"
  echo "  config        Configure API keys (add/update without reinstalling)"
  echo "  marketplace   Search and install MCP packages from Smithery"
  echo ""
  echo -e "${BLUE}Maintenance Commands:${NC}"
  echo "  update        Update CodeAgent to latest version"
  echo "  backup        Backup memory (A-MEM)"
  echo "  restore       Restore memory from backup"
  echo "  tools         Install/check development tools (linters, formatters)"
  echo "  uninstall     Remove CodeAgent completely"
  echo ""
  echo -e "${BLUE}Claude Code Commands:${NC} (use in Claude Code)"
  echo "  /scan         Index codebase + build knowledge graph"
  echo "  /analyze      Research before planning (creates research items)"
  echo "  /plan         Create epics/tasks from requirements"
  echo "  /implement    TDD implementation (consumes tasks)"
  echo "  /backlog      View/manage project backlog"
  echo "  /review       Validate with external tools"
  echo ""
  echo -e "${BLUE}Options:${NC}"
  echo "  -h, --help    Show this help message"
  echo "  -v, --version Show version"
  echo ""
}

# Verify installation
check_install() {
  if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${RED}Error: CodeAgent not installed at $INSTALL_DIR${NC}"
    echo "Run the installer first: curl -fsSL URL | bash"
    exit 1
  fi
}

case "${1:-help}" in
  start)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-start" "${@:2}"
    ;;
  stop)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-stop" "${@:2}"
    ;;
  restart)
    check_install
    "$INSTALL_DIR/bin/codeagent-stop" "${@:2}"
    "$INSTALL_DIR/bin/codeagent-start" "${@:2}"
    ;;
  status)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-status" "${@:2}"
    ;;
  init)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-init" "${@:2}"
    ;;
  index)
    check_install
    # Check if in a CodeAgent project
    if [ ! -d ".codeagent" ]; then
      echo -e "${RED}Error: Not a CodeAgent project (no .codeagent/ directory)${NC}"
      echo "Run 'codeagent init' first"
      exit 1
    fi
    exec "$INSTALL_DIR/bin/codeagent-index" "${@:2}"
    ;;
  backlog)
    check_install
    # Check if in a CodeAgent project
    if [ ! -d ".codeagent" ]; then
      echo -e "${RED}Error: Not a CodeAgent project (no .codeagent/ directory)${NC}"
      echo "Run 'codeagent init' first"
      exit 1
    fi
    exec "$INSTALL_DIR/bin/codeagent-backlog" "${@:2}"
    ;;
  worktree)
    check_install
    # Must be in a git repository
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
      echo -e "${RED}Error: Not a git repository${NC}"
      exit 1
    fi
    exec "$INSTALL_DIR/bin/codeagent-worktree" "${@:2}"
    ;;
  config)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-config" "${@:2}"
    ;;
  marketplace)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-marketplace" "${@:2}"
    ;;
  logs)
    check_install
    cd "$INSTALL_DIR/infrastructure"
    follow=false
    service=""
    lines=100

    # Parse logs arguments
    shift
    while [[ $# -gt 0 ]]; do
      case $1 in
        -f | --follow)
          follow=true
          shift
          ;;
        -n | --lines)
          lines="$2"
          shift 2
          ;;
        qdrant)
          service="$1"
          shift
          ;;
        all)
          service=""
          shift
          ;;
        *)
          shift
          ;;
      esac
    done

    if [ "$follow" = true ]; then
      if [ -n "$service" ]; then
        docker compose logs -f "$service"
      else
        docker compose logs -f
      fi
    else
      if [ -n "$service" ]; then
        docker compose logs --tail="$lines" "$service"
      else
        docker compose logs --tail="$lines"
      fi
    fi
    ;;
  update)
    check_install
    exec "$INSTALL_DIR/scripts/update.sh" "${@:2}"
    ;;
  backup)
    check_install
    exec "$INSTALL_DIR/scripts/backup-memory.sh" "${@:2}"
    ;;
  restore)
    check_install
    exec "$INSTALL_DIR/scripts/restore-memory.sh" "${@:2}"
    ;;
  tools)
    check_install
    exec "$INSTALL_DIR/bin/codeagent-tools" "${@:2}"
    ;;
  uninstall)
    check_install
    exec "$INSTALL_DIR/uninstall.sh" "${@:2}"
    ;;
  version | -v | --version)
    echo "CodeAgent v$VERSION"
    ;;
  help | -h | --help)
    usage
    ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    echo ""
    usage
    exit 1
    ;;
esac
