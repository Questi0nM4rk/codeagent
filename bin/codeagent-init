#!/bin/bash
# ============================================
# CodeAgent Init
# Initialize CodeAgent infrastructure for a project
#
# This sets up per-project structure:
# - .codeagent/          Full project state
#   - backlog/           Task management (epics, tasks, bugs, research)
#   - knowledge/         Knowledge accumulation
#   - index/             Codebase RAG index
#   - sessions/          Session state
# - .claude/             Claude Code config
# - docs/decisions/      Architecture decision records
#
# Memory system:
# - A-MEM uses global storage at ~/.codeagent/memory/
# - Shared across all projects (brain-like memory)
# ============================================

set -e

PROJECT_DIR="$(pwd)"
INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"
FRAMEWORK_DIR="$HOME/.claude/framework"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================
# Main Script
# ============================================

echo -e "${CYAN}Initializing CodeAgent v2 in: ${NC}$PROJECT_DIR"
echo ""

# Check global installation
if [ ! -d "$HOME/.claude/skills" ] || [ ! -d "$HOME/.claude/commands" ]; then
    echo -e "${YELLOW}!${NC} Global CodeAgent not installed"
    echo -e "${YELLOW}!${NC} Run 'install.sh' first to install skills/commands to ~/.claude/"
    echo ""
fi

# Detect project type
detect_project_type() {
    if ls *.csproj *.sln 2>/dev/null | head -1 > /dev/null; then
        echo "dotnet"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "CMakeLists.txt" ] || [ -f "Makefile" ] || ls *.cpp *.c 2>/dev/null | head -1 > /dev/null; then
        echo "cpp"
    elif [ -f "init.lua" ] || ls *.rockspec 2>/dev/null | head -1 > /dev/null; then
        echo "lua"
    elif [ -f "package.json" ]; then
        echo "node"
    elif [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
        echo "python"
    else
        echo "generic"
    fi
}

# Generate ID prefix from project name (first letters of words, max 3)
generate_id_prefix() {
    local name="$1"
    # Split on non-alphanumeric, take first letter of each word, uppercase, max 3
    echo "$name" | sed 's/[^a-zA-Z0-9]/ /g' | awk '{
        result = ""
        for (i=1; i<=NF && i<=3; i++) {
            result = result toupper(substr($i, 1, 1))
        }
        print result
    }'
}

PROJECT_TYPE=$(detect_project_type)
PROJECT_NAME=$(basename "$PROJECT_DIR")
ID_PREFIX=$(generate_id_prefix "$PROJECT_NAME")
TIMESTAMP=$(date -Iseconds)

echo -e "${BLUE}Project:${NC} $PROJECT_NAME ($PROJECT_TYPE)"
echo -e "${BLUE}ID Prefix:${NC} $ID_PREFIX (for tasks: ${ID_PREFIX}-001)"
echo ""

# ============================================
# Create CodeAgent Project Structure
# ============================================

echo -e "${BLUE}Creating .codeagent/ structure...${NC}"

# Create all directories
mkdir -p .codeagent/backlog/epics
mkdir -p .codeagent/backlog/tasks
mkdir -p .codeagent/backlog/bugs
mkdir -p .codeagent/backlog/research
mkdir -p .codeagent/knowledge/summaries
mkdir -p .codeagent/knowledge/outputs
mkdir -p .codeagent/knowledge/external
mkdir -p .codeagent/index/chunks
mkdir -p .codeagent/sessions/history

echo -e "  ${GREEN}+${NC} .codeagent/backlog/{epics,tasks,bugs,research}/"
echo -e "  ${GREEN}+${NC} .codeagent/knowledge/{summaries,outputs,external}/"
echo -e "  ${GREEN}+${NC} .codeagent/index/chunks/"
echo -e "  ${GREEN}+${NC} .codeagent/sessions/history/"

# ============================================
# Generate config.yaml
# ============================================

echo ""
echo -e "${BLUE}Generating configuration...${NC}"

cat > .codeagent/config.yaml <<EOF
# CodeAgent Project Configuration
# Generated by: codeagent init
# Location: .codeagent/config.yaml

project:
  name: "$PROJECT_NAME"
  type: "$PROJECT_TYPE"
  path: "$PROJECT_DIR"
  initialized: "$TIMESTAMP"

backlog:
  id_prefix: "$ID_PREFIX"
  auto_number: true
  statuses: [backlog, ready, in_progress, blocked, done]
  priorities: [critical, high, medium, low]

indexing:
  enabled: true
  incremental: true
  languages: []
  exclude:
    - ".git/"
    - ".codeagent/"
    - "node_modules/"
    - "bin/"
    - "obj/"
    - "target/"
    - "dist/"
    - "build/"
    - "__pycache__/"
    - ".venv/"

memory:
  project_tag: "project:$PROJECT_NAME"
  auto_summarize: true
  store_patterns: true

knowledge:
  auto_update_project_md: true
EOF

echo -e "  ${GREEN}+${NC} .codeagent/config.yaml"

# ============================================
# Generate Initial PROJECT.md
# ============================================

cat > .codeagent/knowledge/PROJECT.md <<EOF
# $PROJECT_NAME Knowledge Base

**Type:** $PROJECT_TYPE
**Initialized:** $TIMESTAMP
**Last Updated:** $TIMESTAMP

## Overview

[Project overview will be populated as work progresses]

## Architecture

[Architecture patterns and decisions will accumulate here]

## Key Decisions

| Date | Decision | Rationale | Task |
|------|----------|-----------|------|

## Recent Completions

[Completed tasks will be summarized here]

## Open Items

### Epics
- (none yet)

### Research
- (none yet)

---

*This document is auto-updated by CodeAgent. Knowledge accumulates as tasks complete.*
EOF

echo -e "  ${GREEN}+${NC} .codeagent/knowledge/PROJECT.md"

# ============================================
# Generate Initial BACKLOG.md
# ============================================

cat > .codeagent/backlog/BACKLOG.md <<EOF
# $PROJECT_NAME Backlog

**Last Updated:** $TIMESTAMP

## Summary

| Type     | Backlog | Ready | In Progress | Done |
|----------|---------|-------|-------------|------|
| Epics    | 0       | 0     | 0           | 0    |
| Tasks    | 0       | 0     | 0           | 0    |
| Bugs     | 0       | 0     | 0           | 0    |
| Research | 0       | 0     | 0           | 0    |

## In Progress

(none)

## Ready

(none)

## Backlog

(none)

---

*This view is auto-generated. Source of truth is YAML files in backlog/ subdirectories.*
EOF

echo -e "  ${GREEN}+${NC} .codeagent/backlog/BACKLOG.md"

# ============================================
# Generate Empty Index Manifest
# ============================================

cat > .codeagent/index/manifest.json <<EOF
{
  "version": 1,
  "created": "$TIMESTAMP",
  "updated": "$TIMESTAMP",
  "root_hash": null,
  "stats": {
    "total_files": 0,
    "indexed_files": 0,
    "total_chunks": 0,
    "languages": {}
  },
  "tree": {}
}
EOF

echo -e "  ${GREEN}+${NC} .codeagent/index/manifest.json"

# ============================================
# Create .claude/ (compatibility)
# ============================================

echo ""
echo -e "${BLUE}Creating .claude/ (Claude Code config)...${NC}"

mkdir -p .claude docs/decisions

cat > .claude/project-info <<EOF
PROJECT_NAME=$PROJECT_NAME
PROJECT_TYPE=$PROJECT_TYPE
PROJECT_PATH=$PROJECT_DIR
INITIALIZED=$TIMESTAMP
EOF

echo -e "  ${GREEN}+${NC} .claude/project-info"
echo -e "  ${GREEN}+${NC} docs/decisions/"

# ============================================
# Update .gitignore
# ============================================

echo ""
echo -e "${BLUE}Checking .gitignore...${NC}"

if [ -f ".gitignore" ]; then
    # Check if .codeagent already ignored
    if ! grep -q "^\.codeagent/" .gitignore 2>/dev/null; then
        echo "" >> .gitignore
        echo "# CodeAgent local state" >> .gitignore
        echo ".codeagent/index/" >> .gitignore
        echo ".codeagent/sessions/" >> .gitignore
        echo -e "  ${GREEN}+${NC} Added .codeagent/index/ and sessions/ to .gitignore"
    else
        echo -e "  ${CYAN}~${NC} .codeagent already in .gitignore"
    fi
else
    cat > .gitignore <<EOF
# CodeAgent local state
.codeagent/index/
.codeagent/sessions/
EOF
    echo -e "  ${GREEN}+${NC} Created .gitignore with CodeAgent entries"
fi

# ============================================
# Check A-MEM Memory System
# ============================================

echo ""
echo -e "${BLUE}Checking A-MEM memory system...${NC}"

MEMORY_DIR="$INSTALL_DIR/memory"
if [ -d "$MEMORY_DIR" ]; then
    MEM_COUNT=$(find "$MEMORY_DIR" -name "*.json" 2>/dev/null | wc -l || echo "0")
    echo -e "  ${GREEN}~${NC} A-MEM storage: $MEMORY_DIR"
    echo -e "  ${CYAN}   ${NC}Existing memories: $MEM_COUNT files"
else
    mkdir -p "$MEMORY_DIR"
    echo -e "  ${GREEN}+${NC} Created A-MEM storage: $MEMORY_DIR"
fi

# ============================================
# Summary
# ============================================

echo ""
echo -e "${GREEN}+============================================================+${NC}"
echo -e "${GREEN}|              CodeAgent v2 Infrastructure Ready             |${NC}"
echo -e "${GREEN}+============================================================+${NC}"
echo ""
echo "Created:"
echo "  .codeagent/"
echo "  +-- config.yaml              (project configuration)"
echo "  +-- backlog/"
echo "  |   +-- epics/               (high-level features)"
echo "  |   +-- tasks/               (implementation units)"
echo "  |   +-- bugs/                (defect tracking)"
echo "  |   +-- research/            (investigation items)"
echo "  |   +-- BACKLOG.md           (human-readable view)"
echo "  +-- knowledge/"
echo "  |   +-- PROJECT.md           (accumulated knowledge)"
echo "  |   +-- summaries/           (task completion summaries)"
echo "  |   +-- outputs/             (research outputs)"
echo "  |   +-- external/            (cached external docs)"
echo "  +-- index/"
echo "  |   +-- manifest.json        (Merkle tree for change detection)"
echo "  |   +-- chunks/              (indexed code chunks)"
echo "  +-- sessions/"
echo "      +-- history/             (past session state)"
echo ""
echo -e "${CYAN}Next steps in Claude Code:${NC}"
echo "  /scan              Index codebase + build knowledge graph"
echo "  /analyze \"topic\"   Research before planning"
echo "  /plan \"task\"       Create epics/tasks"
echo "  /implement         Execute with TDD"
echo "  /backlog           View/manage tasks"
echo ""
