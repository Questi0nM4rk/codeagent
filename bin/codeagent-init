#!/bin/bash
# ============================================
# CodeAgent Init
# Initialize CodeAgent infrastructure for a project
#
# This ONLY sets up infrastructure:
# - Letta agent (per-project memory)
# - docs/decisions/ directory
#
# CLAUDE.md is created by /init slash command
# Global config (skills, commands, settings) is
# installed to ~/.claude/ by install.sh
# ============================================

set -e

PROJECT_DIR="$(pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================
# Main Script
# ============================================

echo -e "${CYAN}Initializing CodeAgent infrastructure in: ${NC}$PROJECT_DIR"
echo ""

# Check global installation
if [ ! -d "$HOME/.claude/skills" ] || [ ! -d "$HOME/.claude/commands" ]; then
    echo -e "${YELLOW}!${NC} Global CodeAgent not installed"
    echo -e "${YELLOW}!${NC} Run 'install.sh' first to install skills/commands to ~/.claude/"
    echo ""
fi

# Detect project type (used for Letta agent description)
detect_project_type() {
    if ls *.csproj *.sln 2>/dev/null | head -1 > /dev/null; then
        echo "dotnet"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "CMakeLists.txt" ] || [ -f "Makefile" ] || ls *.cpp *.c 2>/dev/null | head -1 > /dev/null; then
        echo "cpp"
    elif [ -f "init.lua" ] || ls *.rockspec 2>/dev/null | head -1 > /dev/null; then
        echo "lua"
    else
        echo "generic"
    fi
}

PROJECT_TYPE=$(detect_project_type)
echo -e "${BLUE}Detected project type:${NC} $PROJECT_TYPE"
echo ""

# ============================================
# Create Project Directories
# ============================================

echo -e "${BLUE}Creating project structure...${NC}"
mkdir -p .claude docs/decisions
echo -e "  ${GREEN}✓${NC} Created .claude/ (for letta-agent ID)"
echo -e "  ${GREEN}✓${NC} Created docs/decisions/ (architecture decision records)"

# ============================================
# Create Letta Agent for Project
# ============================================

echo ""
echo -e "${BLUE}Setting up Letta memory agent...${NC}"

# Get project name from directory (sanitize for agent name)
PROJECT_NAME=$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

# Check if Letta is running
if curl -sf http://localhost:8283/v1/health/ > /dev/null 2>&1; then
    # Check if agent already exists
    EXISTING_AGENT=$(curl -sfL "http://localhost:8283/v1/agents/" 2>/dev/null | grep -o "\"name\":\"codeagent-$PROJECT_NAME\"" || true)

    if [ -n "$EXISTING_AGENT" ]; then
        echo -e "  ${GREEN}✓${NC} Letta agent already exists: codeagent-$PROJECT_NAME"

        # Try to get and store agent ID
        AGENT_ID=$(curl -sfL "http://localhost:8283/v1/agents/" 2>/dev/null | grep -o "\"id\":\"[^\"]*\",\"name\":\"codeagent-$PROJECT_NAME\"" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 || true)
        if [ -n "$AGENT_ID" ]; then
            echo "$AGENT_ID" > .claude/letta-agent
        fi
    else
        # Create agent via Letta API
        AGENT_RESPONSE=$(curl -sfL -X POST "http://localhost:8283/v1/agents/" \
            -H "Content-Type: application/json" \
            -d "{
                \"name\": \"codeagent-$PROJECT_NAME\",
                \"description\": \"CodeAgent memory for $PROJECT_NAME ($PROJECT_TYPE project)\",
                \"memory_blocks\": [
                    {\"label\": \"persona\", \"value\": \"I am a coding assistant for $PROJECT_NAME. I remember context, patterns, and decisions across sessions. I help with $PROJECT_TYPE development.\", \"limit\": 5000},
                    {\"label\": \"human\", \"value\": \"Developer working on $PROJECT_NAME\", \"limit\": 3000},
                    {\"label\": \"project\", \"value\": \"Project: $PROJECT_NAME\\nType: $PROJECT_TYPE\\nPath: $PROJECT_DIR\", \"limit\": 2000}
                ]
            }" 2>/dev/null)

        if [ $? -eq 0 ] && [ -n "$AGENT_RESPONSE" ]; then
            AGENT_ID=$(echo "$AGENT_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
            if [ -n "$AGENT_ID" ]; then
                echo -e "  ${GREEN}✓${NC} Created Letta agent: codeagent-$PROJECT_NAME"
                echo -e "  ${CYAN}Agent ID:${NC} $AGENT_ID"

                # Store agent ID in .claude/letta-agent for reference
                echo "$AGENT_ID" > .claude/letta-agent
                echo -e "  ${GREEN}✓${NC} Saved agent ID to .claude/letta-agent"
            else
                echo -e "  ${YELLOW}!${NC} Agent created but could not parse ID"
            fi
        else
            echo -e "  ${YELLOW}!${NC} Could not create Letta agent (API error)"
            echo -e "  ${YELLOW}!${NC} Run 'codeagent init' again after starting services"
        fi
    fi
else
    echo -e "  ${YELLOW}!${NC} Letta not running - skipping agent creation"
    echo -e "  ${YELLOW}!${NC} Run 'codeagent start' then 'codeagent init' to create agent"
fi

# ============================================
# Summary
# ============================================

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║              CodeAgent Infrastructure Ready!                    ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Created:"
echo "  ├── .claude/"
echo "  │   └── letta-agent        (Letta agent ID for this project)"
echo "  └── docs/"
echo "      └── decisions/         (architecture decision records)"
echo ""
echo "Global config (from ~/.claude/):"
echo "  ├── skills/                (researcher, architect, implementer, ...)"
echo "  ├── commands/              (/scan, /plan, /implement, /init, /review)"
echo "  └── settings.json          (permissions, hooks, MCPs)"
echo ""
echo -e "${CYAN}Next steps in Claude Code:${NC}"
echo "  /init              Create CLAUDE.md for this project"
echo "  /scan              Build knowledge graph"
echo "  /plan \"task\"       Research + design"
echo ""
