#!/bin/bash
# ============================================
# CodeAgent Init
# Initialize CodeAgent infrastructure for a project
#
# This sets up per-project structure:
# - .claude/ directory
# - docs/decisions/ for architecture records
#
# Memory system:
# - A-MEM uses global storage at ~/.codeagent/memory/
# - Shared across all projects (brain-like memory)
# - No per-project agent needed
#
# CLAUDE.md is created by /init slash command
# Global config (skills, commands, settings) is
# installed to ~/.claude/ by install.sh
# ============================================

set -e

PROJECT_DIR="$(pwd)"
INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================
# Main Script
# ============================================

echo -e "${CYAN}Initializing CodeAgent infrastructure in: ${NC}$PROJECT_DIR"
echo ""

# Check global installation
if [ ! -d "$HOME/.claude/skills" ] || [ ! -d "$HOME/.claude/commands" ]; then
    echo -e "${YELLOW}!${NC} Global CodeAgent not installed"
    echo -e "${YELLOW}!${NC} Run 'install.sh' first to install skills/commands to ~/.claude/"
    echo ""
fi

# Detect project type (for documentation)
detect_project_type() {
    if ls *.csproj *.sln 2>/dev/null | head -1 > /dev/null; then
        echo "dotnet"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "CMakeLists.txt" ] || [ -f "Makefile" ] || ls *.cpp *.c 2>/dev/null | head -1 > /dev/null; then
        echo "cpp"
    elif [ -f "init.lua" ] || ls *.rockspec 2>/dev/null | head -1 > /dev/null; then
        echo "lua"
    elif [ -f "package.json" ]; then
        echo "node"
    elif [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
        echo "python"
    else
        echo "generic"
    fi
}

PROJECT_TYPE=$(detect_project_type)
PROJECT_NAME=$(basename "$PROJECT_DIR")
echo -e "${BLUE}Project:${NC} $PROJECT_NAME ($PROJECT_TYPE)"
echo ""

# ============================================
# Create Project Directories
# ============================================

echo -e "${BLUE}Creating project structure...${NC}"
mkdir -p .claude docs/decisions

# Store project info for memory tagging
cat > .claude/project-info <<EOF
PROJECT_NAME=$PROJECT_NAME
PROJECT_TYPE=$PROJECT_TYPE
PROJECT_PATH=$PROJECT_DIR
INITIALIZED=$(date -Iseconds)
EOF

echo -e "  ${GREEN}✓${NC} Created .claude/"
echo -e "  ${GREEN}✓${NC} Created docs/decisions/ (architecture decision records)"
echo -e "  ${GREEN}✓${NC} Saved project info to .claude/project-info"

# ============================================
# Initialize A-MEM Memory Storage
# ============================================

echo ""
echo -e "${BLUE}Checking A-MEM memory system...${NC}"

MEMORY_DIR="$INSTALL_DIR/memory"
if [ -d "$MEMORY_DIR" ]; then
    # Count existing memories
    MEM_COUNT=$(find "$MEMORY_DIR" -name "*.json" 2>/dev/null | wc -l || echo "0")
    echo -e "  ${GREEN}✓${NC} A-MEM storage: $MEMORY_DIR"
    echo -e "  ${CYAN}   ${NC}Existing memories: $MEM_COUNT files"
else
    mkdir -p "$MEMORY_DIR"
    echo -e "  ${GREEN}✓${NC} Created A-MEM storage: $MEMORY_DIR"
fi

echo ""
echo -e "${CYAN}Memory system:${NC}"
echo "  A-MEM uses global storage shared across all projects."
echo "  Memories automatically link and evolve over time."
echo "  Use 'project:$PROJECT_NAME' tag to filter project-specific memories."

# ============================================
# Summary
# ============================================

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║              CodeAgent Infrastructure Ready!                    ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Created:"
echo "  ├── .claude/"
echo "  │   └── project-info        (project metadata for memory tagging)"
echo "  └── docs/"
echo "      └── decisions/          (architecture decision records)"
echo ""
echo "Global resources:"
echo "  ├── ~/.claude/skills/       (researcher, architect, implementer, ...)"
echo "  ├── ~/.claude/commands/     (/scan, /plan, /implement, /review)"
echo "  └── ~/.codeagent/memory/    (A-MEM brain-like memory - shared)"
echo ""
echo -e "${CYAN}Next steps in Claude Code:${NC}"
echo "  /init              Create CLAUDE.md for this project"
echo "  /scan              Build knowledge graph"
echo "  /plan \"task\"       Research + design"
echo ""
