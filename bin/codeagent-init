#!/bin/bash
# ============================================
# CodeAgent Init
# Initialize CodeAgent in a project
# ============================================

set -e

INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"
PROJECT_DIR="$(pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}Initializing CodeAgent in: ${NC}$PROJECT_DIR"
echo ""

# Detect project type
detect_project_type() {
    if ls *.csproj *.sln 2>/dev/null | head -1 > /dev/null; then
        echo "dotnet"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "CMakeLists.txt" ] || [ -f "Makefile" ] || ls *.cpp *.c 2>/dev/null | head -1 > /dev/null; then
        echo "cpp"
    elif [ -f "init.lua" ] || ls *.rockspec 2>/dev/null | head -1 > /dev/null; then
        echo "lua"
    else
        echo "generic"
    fi
}

PROJECT_TYPE=$(detect_project_type)
echo -e "${BLUE}Detected project type:${NC} $PROJECT_TYPE"
echo ""

# Create directories
echo -e "${BLUE}Creating directory structure...${NC}"
mkdir -p .claude/skills .claude/commands docs/decisions

# Copy skills (Claude Code's native extension system)
echo -e "${BLUE}Installing skills...${NC}"
if [ -d "$INSTALL_DIR/framework/skills" ]; then
    cp -r "$INSTALL_DIR/framework/skills/"* .claude/skills/ 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} researcher (context gathering)"
    echo -e "  ${GREEN}✓${NC} architect (solution design)"
    echo -e "  ${GREEN}✓${NC} orchestrator (parallel analysis)"
    echo -e "  ${GREEN}✓${NC} implementer (TDD coding)"
    echo -e "  ${GREEN}✓${NC} reviewer (external validation)"
    echo -e "  ${GREEN}✓${NC} learner (pattern extraction)"
else
    echo -e "  ${YELLOW}○${NC} Skill templates not found"
fi

# Copy commands
echo ""
echo -e "${BLUE}Installing commands...${NC}"
if [ -d "$INSTALL_DIR/framework/commands" ]; then
    cp "$INSTALL_DIR/framework/commands/"*.md .claude/commands/ 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} scan.md"
    echo -e "  ${GREEN}✓${NC} plan.md"
    echo -e "  ${GREEN}✓${NC} implement.md"
    echo -e "  ${GREEN}✓${NC} integrate.md"
    echo -e "  ${GREEN}✓${NC} review.md"
else
    echo -e "  ${YELLOW}○${NC} Command templates not found"
fi

# Copy settings (includes permissions, hooks, and MCP config)
echo ""
echo -e "${BLUE}Installing settings...${NC}"
if [ ! -f ".claude/settings.json" ]; then
    if [ -f "$INSTALL_DIR/framework/settings.json.template" ]; then
        cp "$INSTALL_DIR/framework/settings.json.template" .claude/settings.json
        echo -e "  ${GREEN}✓${NC} settings.json (permissions, hooks, MCPs)"
    fi
else
    echo -e "  ${YELLOW}○${NC} settings.json already exists"
fi

# Create or update CLAUDE.md
echo ""
echo -e "${BLUE}Setting up CLAUDE.md...${NC}"
if [ ! -f "CLAUDE.md" ]; then
    TEMPLATE_PATH="$INSTALL_DIR/templates/$PROJECT_TYPE/CLAUDE.md"
    if [ -f "$TEMPLATE_PATH" ]; then
        cp "$TEMPLATE_PATH" CLAUDE.md
        echo -e "  ${GREEN}✓${NC} Created CLAUDE.md (from $PROJECT_TYPE template)"
    else
        # Create a generic one
        cat > CLAUDE.md << 'CLAUDEMD'
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

[Describe your project here]

## Commands

```bash
# Build
[your build command]

# Test
[your test command]

# Run
[your run command]
```

## Architecture

[Describe key architectural decisions]

## Conventions

[List coding conventions and patterns]
CLAUDEMD
        echo -e "  ${GREEN}✓${NC} Created generic CLAUDE.md"
    fi
    echo -e "  ${YELLOW}!${NC} Please customize CLAUDE.md for your project"
else
    echo -e "  ${YELLOW}○${NC} CLAUDE.md already exists"
fi

# Summary
echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                  Project Initialized!                           ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Created:"
echo "  ├── CLAUDE.md                 (project config - customize this!)"
echo "  ├── .claude/"
echo "  │   ├── settings.json         (permissions, hooks, MCPs)"
echo "  │   ├── skills/               (Claude Code skills)"
echo "  │   │   ├── researcher/       (context gathering)"
echo "  │   │   ├── architect/        (solution design)"
echo "  │   │   ├── orchestrator/     (parallel analysis)"
echo "  │   │   ├── implementer/      (TDD coding)"
echo "  │   │   ├── reviewer/         (external validation)"
echo "  │   │   └── learner/          (pattern extraction)"
echo "  │   └── commands/             (slash commands)"
echo "  │       ├── scan.md"
echo "  │       ├── plan.md"
echo "  │       ├── implement.md"
echo "  │       ├── integrate.md"
echo "  │       └── review.md"
echo "  └── docs/"
echo "      └── decisions/"
echo ""
echo -e "${CYAN}Usage:${NC}"
echo "  /scan              Build knowledge graph (run once)"
echo "  /plan \"task\"       Research + design"
echo "  /implement         TDD execution"
echo "  /review            Validate with external tools"
echo ""
echo -e "${YELLOW}Next: Edit CLAUDE.md, then run /scan in Claude Code${NC}"
echo ""
