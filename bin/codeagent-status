#!/bin/bash
# ============================================
# CodeAgent Status
# Check health of all services
# ============================================

INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}CodeAgent Service Status${NC}"
echo "========================"
echo ""

check_service() {
    local name=$1
    local container=$2
    local url=$3

    # Check if container exists
    if ! docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        echo -e "${RED}✗${NC} $name: not created"
        return 1
    fi

    # Check if container is running
    if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        echo -e "${YELLOW}○${NC} $name: stopped"
        return 1
    fi

    # Check health status
    local health=$(docker inspect --format='{{.State.Health.Status}}' "$container" 2>/dev/null || echo "unknown")

    case "$health" in
        healthy)
            echo -e "${GREEN}✓${NC} $name: running (healthy)"
            if [ -n "$url" ]; then
                echo -e "    └─ ${BLUE}$url${NC}"
            fi
            return 0
            ;;
        unhealthy)
            echo -e "${RED}✗${NC} $name: unhealthy"
            return 1
            ;;
        starting)
            echo -e "${YELLOW}◐${NC} $name: starting..."
            return 1
            ;;
        *)
            echo -e "${YELLOW}?${NC} $name: running (status: $health)"
            return 0
            ;;
    esac
}

echo -e "${BLUE}Infrastructure Services${NC}"
echo "───────────────────────"
check_service "Neo4j (code graph)" "codeagent-neo4j" "http://localhost:7474"
check_service "Qdrant (vectors)" "codeagent-qdrant" "http://localhost:6333"
check_service "Letta (memory)" "codeagent-letta" "http://localhost:8283"

echo ""
echo -e "${BLUE}Environment${NC}"
echo "───────────────────────"

if [ -n "$OPENAI_API_KEY" ]; then
    # Mask the key
    masked="${OPENAI_API_KEY:0:7}...${OPENAI_API_KEY: -4}"
    echo -e "${GREEN}✓${NC} OPENAI_API_KEY: $masked"
else
    echo -e "${YELLOW}○${NC} OPENAI_API_KEY: not set"
fi

if [ -n "$CODEAGENT_HOME" ]; then
    echo -e "${GREEN}✓${NC} CODEAGENT_HOME: $CODEAGENT_HOME"
else
    echo -e "${YELLOW}○${NC} CODEAGENT_HOME: not set (using default)"
fi

echo ""
echo -e "${BLUE}MCP Servers${NC}"
echo "───────────────────────"

if command -v claude &> /dev/null; then
    # List configured MCPs
    mcp_list=$(claude mcp list 2>/dev/null || echo "")
    if [ -n "$mcp_list" ]; then
        echo "$mcp_list" | head -15
        mcp_count=$(echo "$mcp_list" | wc -l)
        if [ "$mcp_count" -gt 15 ]; then
            echo "  ... and $((mcp_count - 15)) more"
        fi
    else
        echo -e "${YELLOW}○${NC} No MCPs configured (run 'codeagent start')"
    fi
else
    echo -e "${YELLOW}○${NC} Claude Code CLI not found"
fi

echo ""
