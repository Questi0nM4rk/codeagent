#!/bin/bash
# ============================================
# CodeAgent Start
# Start all infrastructure services
# ============================================

set -e

INSTALL_DIR="${CODEAGENT_HOME:-$HOME/.codeagent}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}Starting CodeAgent infrastructure...${NC}"
echo ""

# Check if .env file exists with API keys
ENV_FILE="$INSTALL_DIR/.env"
if [ -f "$ENV_FILE" ] && grep -q "OPENAI_API_KEY=" "$ENV_FILE"; then
  echo -e "${GREEN}✓${NC} API keys configured in $ENV_FILE"
else
  echo -e "${YELLOW}Warning: OPENAI_API_KEY not found in $ENV_FILE${NC}"
  echo "Memory embeddings will not work without it."
  echo "Run './install.sh' to configure API keys."
  echo ""
fi

# Start Docker services (Docker Compose reads .env automatically via env_file directive)
cd "$INSTALL_DIR/infrastructure"

echo -e "${BLUE}Starting Docker services...${NC}"
docker compose up -d

# Wait for services to be ready
echo ""
echo -e "${BLUE}Waiting for services to initialize...${NC}"

# Wait loop with status
max_attempts=30
attempt=0
services_ready=false

while [ $attempt -lt $max_attempts ] && [ "$services_ready" = false ]; do
  attempt=$((attempt + 1))

  qdrant_ready=$(docker inspect --format='{{.State.Health.Status}}' codeagent-qdrant 2>/dev/null || echo "not_found")

  if [ "$qdrant_ready" = "healthy" ]; then
    services_ready=true
  else
    printf "\r  Waiting... (%d/%d) Qdrant: %s    " \
      "$attempt" "$max_attempts" "$qdrant_ready"
    sleep 2
  fi
done

echo ""
echo ""

if [ "$services_ready" = true ]; then
  echo -e "${GREEN}All services are healthy!${NC}"
else
  echo -e "${YELLOW}Some services may still be starting...${NC}"
  echo "Run 'codeagent status' to check."
fi

# Run health check
echo ""
"$INSTALL_DIR/scripts/health-check.sh"

# Install MCPs if Claude Code is available
if command -v claude &>/dev/null; then
  echo ""
  echo -e "${BLUE}Configuring MCP servers...${NC}"
  "$INSTALL_DIR/mcps/install-mcps.sh" 2>/dev/null || true
fi

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                CodeAgent is ready!                          ║${NC}"
echo -e "${GREEN}╠════════════════════════════════════════════════════════════╣${NC}"
echo -e "${GREEN}║  Qdrant API:     ${NC}http://localhost:6333${GREEN}                    ║${NC}"
echo -e "${GREEN}║  A-MEM Memory:   ${NC}~/.codeagent/memory/${GREEN}                     ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Run 'codeagent init' in your project to get started."
echo ""
