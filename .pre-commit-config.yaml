# =============================================================================
# PEDANTIC Pre-Commit Configuration for AI-Driven Development
# =============================================================================
# AI Guardrails - Multi-language strict enforcement
#
# Philosophy: AI agents need hard stops. No warnings, no suggestions.
# Everything is an error or it's ignored. Black/white only.
#
# Requirements enforced:
# - Type annotations (Python, TypeScript)
# - Documentation (docstrings, XML comments, JSDoc)
# - Consistent formatting (via language-specific configs)
# - Static analysis (strict mode, warnings as errors)
# - Security scanning (secrets, vulnerabilities, SAST)
# - Commit message format (conventional commits)
#
# Languages: Python, TypeScript/JS, C#/.NET, Rust, C/C++, Lua, Shell
# Dormant hooks auto-skip if no matching files exist.
# =============================================================================

fail_fast: true
default_language_version:
  python: python3.12
  node: "20.11.0"
  rust: stable

repos:
  # ===========================================================================
  #  FORMAT & STAGE - Auto-fix before checks (skipped in CI)
  # ===========================================================================

  - repo: local
    hooks:
      - id: format-and-stage
        name: " format 路 auto-fix and stage"
        entry: lib/hooks/format-and-stage.sh
        language: script
        always_run: true
        pass_filenames: false

  # ===========================================================================
  #  SECURITY - CRITICAL (runs first, fails fast)
  # ===========================================================================

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.21.2
    hooks:
      - id: gitleaks
        name: " security 路 gitleaks - detect secrets"

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: " security 路 detect-secrets - enhanced"
        args: ["--baseline", ".secrets.baseline"]
        exclude: package-lock\.json|\.secrets\.baseline

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: detect-private-key
        name: " security 路 detect private keys"

  # Semgrep - SAST security patterns
  - repo: https://github.com/semgrep/semgrep
    rev: v1.149.0
    hooks:
      - id: semgrep
        name: " security 路 semgrep SAST scan"
        # --jobs 1: avoid io_uring limits locally; CI runs semgrep separately with full parallelism
        args: ["--config", "auto", "--error", "--jobs", "1"]
        exclude: ^tests/

  # ===========================================================================
  #  COMMIT MESSAGE - CONVENTIONAL COMMITS REQUIRED
  # ===========================================================================

  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.3.0
    hooks:
      - id: conventional-pre-commit
        name: " commit 路 conventional commit format"
        stages: [commit-msg]
        args: [feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert]

  # ===========================================================================
  #  SPELLING - TYPO DETECTION
  # ===========================================================================

  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        name: " spelling 路 codespell typo check"
        args: ["--check-filenames"]
        exclude: ^(poetry\.lock|package-lock\.json|\.secrets\.baseline)$

  # ===========================================================================
  #  PYTHON - PEDANTIC (requires types + docstrings)
  # ===========================================================================

  # Ruff - Lint with ALL rules enabled (uses ruff.toml if present)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.6
    hooks:
      - id: ruff
        name: " python 路 ruff lint (pedantic)"
        args: ["--no-fix"]
      - id: ruff-format
        name: " python 路 ruff format"
        args: ["--check"]

  # Mypy - Static type checking (strict mode)
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.14.1
    hooks:
      - id: mypy
        name: " python 路 mypy type check (strict)"
        args: [
          "--strict",
          "--warn-unreachable",
          "--warn-redundant-casts",
          "--warn-unused-ignores",
          "--no-implicit-reexport",
          "--disallow-untyped-decorators",
        ]
        additional_dependencies: []

  # Bandit - Security linter
  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.0
    hooks:
      - id: bandit
        name: " python 路 bandit security scan"
        args: ["-ll", "-ii", "-r"]
        exclude: ^tests/

  # Vulture - Dead code detection (static analysis)
  # Catches unused functions, variables, imports without running code
  - repo: https://github.com/jendrikseipp/vulture
    rev: v2.14
    hooks:
      - id: vulture
        name: " python 路 vulture dead code"
        args: ["--min-confidence", "80", "src/", "lib/"]
        pass_filenames: false

  # pip-audit: Auto-configured by ai-guardrails-init based on detected dependency tool
  # Or manually enable based on your setup:
  #
  # For uv:
  #   args: ["--strict", "--progress-spinner", "off", "--locked", "."]
  #
  # For pip + requirements.txt:
  #   args: ["--strict", "--progress-spinner", "off", "-r", "requirements.txt"]
  #
  # For pip + pyproject.toml:
  #   args: ["--strict", "--progress-spinner", "off", "--locked", "."]
  #
  # See README.md section "CVE Scanning with pip-audit" for details.
  #
  # - repo: https://github.com/pypa/pip-audit
  #   rev: v2.10.0
  #   hooks:
  #     - id: pip-audit
  #       name: " python 路 pip-audit CVE scan"
  #       args: ["--strict", "--progress-spinner", "off"]  # Configure based on tool!

  # ===========================================================================
  #  TYPESCRIPT/JAVASCRIPT - PEDANTIC (uses biome.json if present)
  # ===========================================================================

  - repo: https://github.com/biomejs/pre-commit
    rev: "v0.6.1"
    hooks:
      - id: biome-check
        name: " typescript 路 biome lint+format (pedantic)"
        additional_dependencies: ["@biomejs/biome@1.9.4"]
        args: ["--error-on-warnings"]

  - repo: local
    hooks:
      - id: tsc
        name: " typescript 路 tsc type check (strict)"
        entry: npx tsc
        args: ["--noEmit", "--strict", "--skipLibCheck"]
        language: system
        types: [ts, tsx]
        pass_filenames: false

      - id: npm-audit
        name: " typescript 路 npm audit CVE scan"
        entry: npm audit
        args: ["--audit-level=moderate"]
        language: system
        files: package\.json$
        pass_filenames: false

  # ===========================================================================
  #  C# / .NET - PEDANTIC (uses .globalconfig + Directory.Build.props)
  # ===========================================================================

  - repo: local
    hooks:
      - id: dotnet-format
        name: " csharp 路 dotnet format (pedantic)"
        entry: dotnet format
        args: ["--verify-no-changes", "--severity", "info"]
        language: system
        types: [c#]
        pass_filenames: false

      - id: dotnet-build
        name: " csharp 路 dotnet build (warnings as errors)"
        entry: dotnet build
        args: ["--no-restore", "-warnaserror", "-c", "Release"]
        language: system
        types: [c#]
        pass_filenames: false

  # ===========================================================================
  #  RUST - PEDANTIC (uses rustfmt.toml + clippy)
  # ===========================================================================

  - repo: local
    hooks:
      - id: cargo-fmt
        name: " rust 路 cargo fmt check"
        entry: cargo fmt
        args: ["--all", "--check"]
        language: system
        types: [rust]
        pass_filenames: false

      - id: cargo-clippy
        name: " rust 路 clippy (pedantic)"
        entry: cargo clippy
        args: [
          "--all-targets",
          "--all-features",
          "--",
          "-D", "warnings",
          "-D", "clippy::pedantic",
          "-D", "clippy::nursery",
          "-A", "clippy::module_name_repetitions",
        ]
        language: system
        types: [rust]
        pass_filenames: false

      - id: cargo-doc
        name: " rust 路 cargo doc (error on missing docs)"
        entry: env RUSTDOCFLAGS="-D missing_docs -D rustdoc::broken_intra_doc_links" cargo doc
        args: ["--no-deps", "--all-features"]
        language: system
        types: [rust]
        pass_filenames: false

      - id: cargo-audit
        name: " rust 路 cargo audit CVE scan"
        entry: cargo audit
        args: ["--deny", "warnings"]
        language: system
        types: [rust]
        pass_filenames: false

  # ===========================================================================
  #  C/C++ - PEDANTIC (uses .clang-format + clang-tidy)
  # ===========================================================================

  - repo: https://github.com/pre-commit/mirrors-clang-format
    rev: v19.1.6
    hooks:
      - id: clang-format
        name: " cpp 路 clang-format check"
        args: ["--dry-run", "--Werror"]
        types_or: [c, c++, cuda]

  - repo: local
    hooks:
      - id: clang-tidy
        name: " cpp 路 clang-tidy (pedantic)"
        entry: clang-tidy
        args: [
          "--warnings-as-errors=*",
          "-checks=*,-llvmlibc-*,-fuchsia-*,-altera-*",
        ]
        language: system
        types_or: [c, c++]

  # ===========================================================================
  #  LUA - PEDANTIC (uses stylua.toml)
  # ===========================================================================

  - repo: https://github.com/JohnnyMorganz/StyLua
    rev: v2.0.2
    hooks:
      - id: stylua
        name: " lua 路 stylua format check"
        args: ["--check"]

  - repo: local
    hooks:
      - id: luacheck
        name: " lua 路 luacheck lint"
        entry: luacheck
        args: ["--globals", "vim", "--no-unused-args", "--std", "luajit"]
        language: system
        types: [lua]

  # ===========================================================================
  #  SHELL - STRICT MODE
  # ===========================================================================

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: " shell 路 shellcheck lint"
        args: ["--severity=info"]

  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.10.0-1
    hooks:
      - id: shfmt
        name: " shell 路 shfmt format check"
        args: ["-i", "2", "-ci", "-bn", "-d"]

  # ===========================================================================
  #  MARKDOWN - STRICT MODE
  # ===========================================================================

  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.17.2
    hooks:
      - id: markdownlint-cli2
        name: " markdown 路 markdownlint"

  # ===========================================================================
  #  CONFIG & DATA VALIDATION
  # ===========================================================================

  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.30.0
    hooks:
      - id: check-github-workflows
        name: " github 路 validate workflow files"
      - id: check-github-actions
        name: " github 路 validate action files"

  # TOML validation and formatting
  - repo: https://github.com/ComPWA/taplo-pre-commit
    rev: v0.9.3
    hooks:
      - id: taplo-format
        name: " toml 路 taplo format check"
        args: ["--check"]

  # ===========================================================================
  #  UNIVERSAL QUALITY CHECKS
  # ===========================================================================

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # Whitespace & formatting
      - id: trailing-whitespace
        name: " format 路 trailing whitespace"
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
        name: " format 路 end of file fixer"
      - id: mixed-line-ending
        name: " format 路 mixed line endings"
        args: [--fix=lf]

      # Syntax validation
      - id: check-yaml
        name: " syntax 路 check yaml"
        args: [--unsafe]
      - id: check-json
        name: " syntax 路 check json"
      - id: check-toml
        name: " syntax 路 check toml"
      - id: check-xml
        name: " syntax 路 check xml"

      # Git hygiene
      - id: check-merge-conflict
        name: " git 路 check merge conflicts"
      - id: check-added-large-files
        name: " git 路 check large files"
        args: [--maxkb=500]
      - id: no-commit-to-branch
        name: " git 路 no commit to main"
        args: [--branch=main, --branch=master]

      # File checks
      - id: check-case-conflict
        name: " files 路 case conflict"
      - id: check-symlinks
        name: " files 路 broken symlinks"
      - id: check-executables-have-shebangs
        name: " files 路 executables have shebangs"
      - id: check-shebang-scripts-are-executable
        name: " files 路 shebang scripts executable"

      # Python-specific
      - id: check-ast
        name: " python 路 check ast syntax"
      - id: debug-statements
        name: " python 路 no debug statements"
      - id: name-tests-test
        name: " python 路 test files named test_*"
        args: [--pytest-test-first]

# =============================================================================
# INSTALLATION
# =============================================================================
# pip install pre-commit && pre-commit install && pre-commit install --hook-type commit-msg
#
# Also copy the language-specific configs to project root:
#   - .editorconfig (all languages)
#   - ruff.toml (Python)
#   - biome.json (TypeScript/JavaScript)
#   - .clang-format (C/C++)
#   - stylua.toml (Lua)
#   - rustfmt.toml (Rust)
#   - Directory.Build.props + .globalconfig (C#)
#
# For detect-secrets, initialize baseline:
#   detect-secrets scan > .secrets.baseline
#
# Dormant hooks auto-skip if no matching files exist.
# =============================================================================
