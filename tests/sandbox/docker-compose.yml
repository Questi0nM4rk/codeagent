# CodeAgent Test Sandbox
# Run: docker compose run --rm test
# Or:  ./test.sh [scenario]

services:
  # Full integration test - clones from GitHub using real SSH keys
  test:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-test-sandbox
    environment:
      - HOME=/home/testuser
      - TERM=xterm-256color
      - VERBOSE=${VERBOSE:-false}
      - TEST_MODE=github
      # Fake API keys to skip interactive prompts during testing
      - OPENAI_API_KEY=sk-test-fake-key-for-testing
      - GITHUB_TOKEN=ghp_test_fake_token
      - TAVILY_API_KEY=tvly-test-fake-key
    volumes:
      # Mount SSH keys read-only for GitHub access
      - ~/.ssh:/home/testuser/.ssh:ro
      # Mount source for test scripts only
      - ../..:/home/testuser/codeagent-source:ro
    command: ["/home/testuser/codeagent-source/tests/sandbox/run-tests.sh", "${TEST_SCENARIO:-all}"]
    mem_limit: 2g
    # Network needed for GitHub clone
    network_mode: bridge

  # Local development test - uses local source files (no network)
  test-local:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-test-local
    environment:
      - HOME=/home/testuser
      - TERM=xterm-256color
      - VERBOSE=${VERBOSE:-false}
      - TEST_MODE=local
      - OPENAI_API_KEY=sk-test-fake-key-for-testing
      - GITHUB_TOKEN=ghp_test_fake_token
      - TAVILY_API_KEY=tvly-test-fake-key
    volumes:
      - ../..:/home/testuser/codeagent-source:ro
    command: ["/home/testuser/codeagent-source/tests/sandbox/run-tests.sh", "${TEST_SCENARIO:-all}"]
    mem_limit: 2g
    network_mode: none

  # Interactive shell for debugging (with SSH keys)
  shell:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-test-shell
    environment:
      - HOME=/home/testuser
      - TERM=xterm-256color
    volumes:
      - ~/.ssh:/home/testuser/.ssh:ro
      - ../..:/home/testuser/codeagent-source:ro
    command: ["/bin/bash"]
    stdin_open: true
    tty: true
    mem_limit: 2g
    network_mode: bridge

  # Source validation only (fast, no network)
  lint:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-test-lint
    environment:
      - HOME=/home/testuser
    volumes:
      - ../..:/home/testuser/codeagent-source:ro
    command: ["/home/testuser/codeagent-source/tests/sandbox/run-tests.sh", "source"]
    mem_limit: 1g
    network_mode: none
