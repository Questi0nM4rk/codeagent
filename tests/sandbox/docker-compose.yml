# CodeAgent Test Sandbox with Docker-in-Docker
# All containers created during tests run INSIDE dind, not on host
# Usage: ./test.sh (from host)

services:
  # Docker-in-Docker daemon - isolated Docker environment
  dind:
    image: docker:dind
    container_name: codeagent-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=  # Disable TLS for internal communication
    volumes:
      - dind-storage:/var/lib/docker
    networks:
      - testnet
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Full integration test - uses dind for real Docker
  test:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-test
    environment:
      - HOME=/home/testuser
      - TERM=xterm-256color
      - VERBOSE=${VERBOSE:-false}
      - TEST_SCENARIO=${TEST_SCENARIO:-all}
      # Connect to dind's Docker daemon
      - DOCKER_HOST=tcp://dind:2375
      # Fake API keys for ALL optional MCPs (install testing only)
      - OPENAI_API_KEY=sk-test-fake-key-for-testing-only
      - ANTHROPIC_API_KEY=sk-ant-test-fake-key-for-testing
      - GITHUB_TOKEN=ghp_test_fake_token_for_testing
      - TAVILY_API_KEY=tvly-test-fake-key-for-testing
      - FIGMA_API_KEY=figd_test_fake_key_for_testing
      - SUPABASE_ACCESS_TOKEN=sbp_test_fake_token_for_testing
    volumes:
      # Mount SSH keys read-only for GitHub access
      - ~/.ssh:/home/testuser/.ssh:ro
      # Mount source read-only
      - ../..:/home/testuser/codeagent-source:ro
    depends_on:
      dind:
        condition: service_healthy
    networks:
      - testnet
    command: ["/home/testuser/codeagent-source/tests/sandbox/run-tests.sh"]
    mem_limit: 4g

  # Interactive shell for debugging
  shell:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-shell
    stdin_open: true
    tty: true
    environment:
      - HOME=/home/testuser
      - TERM=xterm-256color
      - DOCKER_HOST=tcp://dind:2375
      - OPENAI_API_KEY=sk-test-fake-key-for-testing-only
      - ANTHROPIC_API_KEY=sk-ant-test-fake-key-for-testing
      - GITHUB_TOKEN=ghp_test_fake_token_for_testing
      - TAVILY_API_KEY=tvly-test-fake-key-for-testing
      - FIGMA_API_KEY=figd_test_fake_key_for_testing
      - SUPABASE_ACCESS_TOKEN=sbp_test_fake_token_for_testing
    volumes:
      - ~/.ssh:/home/testuser/.ssh:ro
      - ../..:/home/testuser/codeagent-source:ro
    depends_on:
      dind:
        condition: service_healthy
    networks:
      - testnet
    command: ["/bin/bash"]

  # Source validation only (fast, no Docker needed)
  lint:
    build:
      context: ../..
      dockerfile: tests/sandbox/Dockerfile
    container_name: codeagent-lint
    environment:
      - HOME=/home/testuser
      - TEST_SCENARIO=source
    volumes:
      - ../..:/home/testuser/codeagent-source:ro
    command: ["/home/testuser/codeagent-source/tests/sandbox/run-tests.sh"]
    mem_limit: 1g
    network_mode: none

networks:
  testnet:
    driver: bridge

volumes:
  dind-storage:
