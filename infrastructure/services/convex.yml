# Convex - Open-source reactive backend
# https://convex.dev/
#
# Access:
#   Backend API: http://localhost:3210
#   Site Proxy:  http://localhost:3211
#   Dashboard:   http://localhost:6791
#
# Usage:
#   CONVEX_SELF_HOSTED_URL=http://localhost:3210
#   CONVEX_SELF_HOSTED_ADMIN_KEY=<from logs on first start>

services:
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: codeagent-convex-backend
    stop_grace_period: 10s
    stop_signal: SIGINT
    restart: unless-stopped
    ports:
      - "${CONVEX_PORT:-3210}:3210"
      - "${CONVEX_SITE_PROXY_PORT:-3211}:3211"
    volumes:
      - codeagent_convex_data:/convex/data
    networks:
      - codeagent-network
    environment:
      - CONVEX_CLOUD_ORIGIN=${CONVEX_CLOUD_ORIGIN:-http://127.0.0.1:3210}
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_ORIGIN:-http://127.0.0.1:3211}
      - DOCUMENT_RETENTION_DELAY=${DOCUMENT_RETENTION_DELAY:-172800}
      - RUST_LOG=${RUST_LOG:-info}
      - DISABLE_BEACON=true
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3210/version || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    container_name: codeagent-convex-dashboard
    stop_grace_period: 10s
    stop_signal: SIGINT
    restart: unless-stopped
    ports:
      - "${CONVEX_DASHBOARD_PORT:-6791}:6791"
    networks:
      - codeagent-network
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=${NEXT_PUBLIC_DEPLOYMENT_URL:-http://127.0.0.1:3210}
    depends_on:
      convex-backend:
        condition: service_healthy

volumes:
  codeagent_convex_data:
    name: codeagent_convex_data

networks:
  codeagent-network:
    external: true
